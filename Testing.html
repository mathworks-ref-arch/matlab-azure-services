<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Unit Tests &mdash; MATLAB Interface for Azure Services Package  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/mathworks.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Frequently Asked Questions" href="FAQ.html" />
    <link rel="prev" title="MATLAB Compiler (SDK) Deployment" href="Deployment.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> MATLAB Interface for Azure Services Package
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Overview.html">MATLAB Interface <em>for Azure Services</em></a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Installation &amp; Configuration</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Configuration.html">Configuration</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Authentication.html">Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="Services.html">Usage Per Service</a></li>
<li class="toctree-l1"><a class="reference internal" href="APIReference.html">API Reference</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced Topics</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Deployment.html">MATLAB Compiler (SDK) Deployment</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Unit Tests</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#common-unit-tests"><code class="docutils literal notranslate"><span class="pre">/Common</span></code> unit tests</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#common-azure-app-registration"><code class="docutils literal notranslate"><span class="pre">Common</span></code> Azure App Registration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#azure-cli">Azure CLI</a></li>
<li class="toctree-l3"><a class="reference internal" href="#common-storage-account"><code class="docutils literal notranslate"><span class="pre">Common</span></code> Storage Account</a></li>
<li class="toctree-l3"><a class="reference internal" href="#common-environment-variables"><code class="docutils literal notranslate"><span class="pre">Common</span></code> environment variables</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#storage-azure-data-lake-storage-gen2-unit-tests"><code class="docutils literal notranslate"><span class="pre">/Storage</span></code> Azure Data Lake Storage Gen2 unit tests</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#azure-app-registration">Azure App Registration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#storage-account">Storage Account</a></li>
<li class="toctree-l3"><a class="reference internal" href="#connection-string-sas-token">Connection String/SAS Token</a></li>
<li class="toctree-l3"><a class="reference internal" href="#storage-environment-variables"><code class="docutils literal notranslate"><span class="pre">Storage</span></code> environment variables</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#keyvault-azure-key-vault-unit-tests"><code class="docutils literal notranslate"><span class="pre">/KeyVault</span></code> Azure Key Vault unit tests</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#key-vault-azure-app-registration">Key Vault Azure App Registration</a></li>
<li class="toctree-l3"><a class="reference internal" href="#key-vault-account">Key Vault Account</a></li>
<li class="toctree-l3"><a class="reference internal" href="#keyvault-environment-variables"><code class="docutils literal notranslate"><span class="pre">KeyVault</span></code> environment variables</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="References.html">References</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MATLAB Interface for Azure Services Package</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Unit Tests</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/mathworks-ref-arch/matlab-azure-services/blob/main/Documentation/Testing.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="unit-tests">
<h1>Unit Tests<a class="headerlink" href="#unit-tests" title="Permalink to this headline"></a></h1>
<p>The package includes various MATLAB® Unit Tests for testing the different
interfaces and clients for the different Azure® services. These tests can be
found in <code class="docutils literal notranslate"><span class="pre">Software/MATLAB/test/unit</span></code> and they are further split into directories
for different Azure services as well as a <code class="docutils literal notranslate"><span class="pre">Common</span></code> directory:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">/Common</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/KeyVault</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/Storage</span></code></p></li>
</ul>
<p>The unit tests for the different services may have different requirements. These
are documented on a per service basis below.</p>
<p>Typically the tests will require an Azure App Registration with certain specific
permissions and a service specific resource with specific content and which is
accessible by the App’s service principal. Details like the App Client ID,
Client Secret, Resource Account Name, etc. which can contain sensitive data, are
provided to the unit tests through environment variables. This also allows the
Unit Tests to be more securely included in CI/CD systems where one can typically
configure variables in a protected and secure way (e.g. through “Actions
secrets” on GitHub or “Masked/Protected Variables” on GitLab, etc.).</p>
<p>It may be possible to use one single App for all different features. This App
will then have to meet all the requirements listed in the sections below. Even
with one App, it is still required to set/provide <code class="docutils literal notranslate"><span class="pre">AZURE_CLIENT_ID</span></code>,
<code class="docutils literal notranslate"><span class="pre">KEYVAULT_CLIENT_ID</span></code>, etc. separately but they could then all have the same
value to point to the same App.</p>
<p>Some tests cannot run non-interactively (e.g. authentication tests which require
user interaction). These tests are automatically skipped if environment variable
<code class="docutils literal notranslate"><span class="pre">GITLAB_CI</span></code>=<code class="docutils literal notranslate"><span class="pre">true</span></code> is set.</p>
<section id="common-unit-tests">
<h2><code class="docutils literal notranslate"><span class="pre">/Common</span></code> unit tests<a class="headerlink" href="#common-unit-tests" title="Permalink to this headline"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">Common</span></code> tests various common features like authentication and networking
features like proxy settings.</p>
<blockquote>
<div><p><strong>NOTE:</strong> the common features cannot be tested entirely independently, to be
properly tested, the credentials or network configuration, etc. also need to
be passed to at least one service specific client which is then interacted
with. The <code class="docutils literal notranslate"><span class="pre">Common</span></code> unit tests, test against <code class="docutils literal notranslate"><span class="pre">BlobServiceClient</span></code>,
<code class="docutils literal notranslate"><span class="pre">BlobContainerClient</span></code>, <code class="docutils literal notranslate"><span class="pre">BlobClient</span></code>, <code class="docutils literal notranslate"><span class="pre">QueueServiceClient</span></code> and <code class="docutils literal notranslate"><span class="pre">QueueClient</span></code>
which are all <code class="docutils literal notranslate"><span class="pre">Storage</span></code> Data Lake Storage Gen2 related client. Hence these
tests also require a storage account resource and corresponding environment
variables.</p>
</div></blockquote>
<section id="common-azure-app-registration">
<h3><code class="docutils literal notranslate"><span class="pre">Common</span></code> Azure App Registration<a class="headerlink" href="#common-azure-app-registration" title="Permalink to this headline"></a></h3>
<p>Configure an Azure App for which a Client Secret has been generated and a
Client Certificate has been registered. Ensure this App’s service principal
is granted access to the storage account used for testing, see also
<a class="reference internal" href="#storage-account"><span class="std std-doc">Storage Account</span></a> below. And if also running the
interactive authentication tests make sure that for this App:</p>
<ul class="simple">
<li><p>A Redirect Uri has been configured in the form of <code class="docutils literal notranslate"><span class="pre">http://localhost:PORT</span></code>
where <em>PORT</em> is configurable.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Allow</span> <span class="pre">public</span> <span class="pre">client</span> <span class="pre">flows</span></code> is enabled.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">https://storage.azure.com/user_impersonation</span></code> API permissions have been
configured.</p></li>
</ul>
</section>
<section id="azure-cli">
<h3>Azure CLI<a class="headerlink" href="#azure-cli" title="Permalink to this headline"></a></h3>
<p>In order to be able to test Azure CLI credentials, Azure CLI must have been
installed and a user must have have already successfully logged in using <code class="docutils literal notranslate"><span class="pre">az</span> <span class="pre">login</span></code>.</p>
<blockquote>
<div><p><strong>NOTE:</strong> The Azure CLI authentication test is skipped when
<code class="docutils literal notranslate"><span class="pre">GITLAB_CI</span></code>=<code class="docutils literal notranslate"><span class="pre">true</span></code>.</p>
</div></blockquote>
</section>
<section id="common-storage-account">
<h3><code class="docutils literal notranslate"><span class="pre">Common</span></code> Storage Account<a class="headerlink" href="#common-storage-account" title="Permalink to this headline"></a></h3>
<p>Configure a storage account as discussed under <code class="docutils literal notranslate"><span class="pre">Storage</span></code> Storage Account.</p>
<p>When also running the interactive tests (including Azure CLI test), the
interactive user which you are logging in as, will also require <code class="docutils literal notranslate"><span class="pre">Contributor</span></code>,
<code class="docutils literal notranslate"><span class="pre">Storage</span> <span class="pre">Blob</span> <span class="pre">Data</span> <span class="pre">Contributor</span></code> and <code class="docutils literal notranslate"><span class="pre">Storage</span> <span class="pre">Queue</span> <span class="pre">Data</span> <span class="pre">Contributor</span></code> roles on
the storage account.</p>
</section>
<section id="common-environment-variables">
<h3><code class="docutils literal notranslate"><span class="pre">Common</span></code> environment variables<a class="headerlink" href="#common-environment-variables" title="Permalink to this headline"></a></h3>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Variable Name</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">COMMON_REDIRECT_URI</span></code></p></td>
<td><p>Redirect URI as configured for App</p></td>
</tr>
</tbody>
</table>
<p>As well as the <code class="docutils literal notranslate"><span class="pre">Storage</span></code> environment variables below.</p>
</section>
</section>
<section id="storage-azure-data-lake-storage-gen2-unit-tests">
<h2><code class="docutils literal notranslate"><span class="pre">/Storage</span></code> Azure Data Lake Storage Gen2 unit tests<a class="headerlink" href="#storage-azure-data-lake-storage-gen2-unit-tests" title="Permalink to this headline"></a></h2>
<section id="azure-app-registration">
<h3>Azure App Registration<a class="headerlink" href="#azure-app-registration" title="Permalink to this headline"></a></h3>
<p>In order to be able to run the Storage tests an App registration is required for
which:</p>
<ul class="simple">
<li><p>A Client Secret has been generated.</p></li>
</ul>
</section>
<section id="storage-account">
<h3>Storage Account<a class="headerlink" href="#storage-account" title="Permalink to this headline"></a></h3>
<p>The storage account should contain three containers:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">containerempty</span></code> which should be empty</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">containernotempty</span></code> which should contain two blobs <em>blob1.txt</em> and
<em>blob2.txt</em>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">leasetest</span></code> which should contain a blob <em>file1.txt</em>.</p></li>
</ul>
<p>Further, make sure that the App’s service principal is assigned <code class="docutils literal notranslate"><span class="pre">Contributor</span></code>,
<code class="docutils literal notranslate"><span class="pre">Storage</span> <span class="pre">Blob</span> <span class="pre">Data</span> <span class="pre">Contributor</span></code> as well as <code class="docutils literal notranslate"><span class="pre">Storage</span> <span class="pre">Queue</span> <span class="pre">Data</span> <span class="pre">Contributor</span></code>
roles on this account.</p>
</section>
<section id="connection-string-sas-token">
<h3>Connection String/SAS Token<a class="headerlink" href="#connection-string-sas-token" title="Permalink to this headline"></a></h3>
<p>Under “Shared access signature” generate a signature with:</p>
<ul class="simple">
<li><p>Allowed Services: “Blob” and “Queue”</p></li>
<li><p>Allowed resource types: “Service”, “Container” and “Object”.</p></li>
<li><p>Allowed permissions: All</p></li>
</ul>
<p>Choose an appropriate expiry date/time; Azure by default appears to suggest a
period of 6 hours which is relatively safe but not very convenient for testing.
Since the account should really only be used for testing anyway and should
not be used to store any sensitive data, it may be acceptable to significantly
increase the validity period in accordance with local security polices.</p>
<p>Similarly one can configure specific allowed IP addresses.</p>
<p>Once generated note down the “Connection string” and “SAS token”.</p>
</section>
<section id="storage-environment-variables">
<h3><code class="docutils literal notranslate"><span class="pre">Storage</span></code> environment variables<a class="headerlink" href="#storage-environment-variables" title="Permalink to this headline"></a></h3>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Variable Name</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">STORAGE_CONNECTION_STRING</span></code></p></td>
<td><p>“Connection string” obtained above</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">STORAGE_ACCOUNT_KEY</span></code></p></td>
<td><p>“SAS token” obtained above</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">STORAGE_ACCOUNT_NAME</span></code></p></td>
<td><p>Name of the storage account</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">AZURE_CLIENT_ID</span></code></p></td>
<td><p>Client ID of the Azure App</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">AZURE_CLIENT_SECRET</span></code></p></td>
<td><p>Client Secret which has been generated for the App</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">AZURE_CLIENT_CERTIFICATE</span></code></p></td>
<td><p>Base64 encoded PEM-format certificate as registered for the App</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">AZURE_TENANT_ID</span></code></p></td>
<td><p>Azure Tenant ID</p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="keyvault-azure-key-vault-unit-tests">
<h2><code class="docutils literal notranslate"><span class="pre">/KeyVault</span></code> Azure Key Vault unit tests<a class="headerlink" href="#keyvault-azure-key-vault-unit-tests" title="Permalink to this headline"></a></h2>
<p>All KeyVault Unit Tests are performed using Client Secret authentication. There
are no interactive tests.</p>
<section id="key-vault-azure-app-registration">
<h3>Key Vault Azure App Registration<a class="headerlink" href="#key-vault-azure-app-registration" title="Permalink to this headline"></a></h3>
<p>In order to be able to run the Key Vault tests an App registration is required
for which:</p>
<ul class="simple">
<li><p>A Client Secret has been generated.</p></li>
</ul>
</section>
<section id="key-vault-account">
<h3>Key Vault Account<a class="headerlink" href="#key-vault-account" title="Permalink to this headline"></a></h3>
<p>A Key Vault account needs to exist:</p>
<ul class="simple">
<li><p>On which soft-delete is enabled.</p></li>
<li><p>For a Key Vault with “Azure role-based access control” permissions model, the
App’s service principal must be assigned <code class="docutils literal notranslate"><span class="pre">Key</span> <span class="pre">Vault</span> <span class="pre">Administrator</span></code> role. For a
Key Vault working with “Vault access policy” permission model the service
principal must have been granted all <code class="docutils literal notranslate"><span class="pre">Key</span> <span class="pre">Management</span> <span class="pre">Operations</span></code> and <code class="docutils literal notranslate"><span class="pre">Secret</span> <span class="pre">Management</span> <span class="pre">Operations</span></code> permissions.</p></li>
<li><p>In which a secret named <code class="docutils literal notranslate"><span class="pre">anakin</span></code> with value <code class="docutils literal notranslate"><span class="pre">darth</span></code> needs to exist.</p></li>
<li><p>In which a RSA key named <code class="docutils literal notranslate"><span class="pre">kvtestkey</span></code> must exist (key size and actual value are
irrelevant).</p></li>
</ul>
</section>
<section id="keyvault-environment-variables">
<h3><code class="docutils literal notranslate"><span class="pre">KeyVault</span></code> environment variables<a class="headerlink" href="#keyvault-environment-variables" title="Permalink to this headline"></a></h3>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Variable Name</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">KEYVAULT_CLIENT_ID</span></code></p></td>
<td><p>Client ID of the Azure App</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">KEYVAULT_CLIENT_SECRET</span></code></p></td>
<td><p>Client Secret which has been generated for the App</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">KEYVAULT_TENANT_ID</span></code></p></td>
<td><p>Azure Tenant ID</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">KEYVAULT_VAULT_NAME</span></code></p></td>
<td><p>Name of the Key Vault</p></td>
</tr>
</tbody>
</table>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Deployment.html" class="btn btn-neutral float-left" title="MATLAB Compiler (SDK) Deployment" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="FAQ.html" class="btn btn-neutral float-right" title="Frequently Asked Questions" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020-2022, MathWorks, Inc..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>