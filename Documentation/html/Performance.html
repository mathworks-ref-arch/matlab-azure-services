<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Performance &mdash; MATLAB Interface for Azure Services  documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/mathworks.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Azure Data Explorer OpenAPI Spec" href="OpenAPI.html" />
    <link rel="prev" title="Dynamic Data" href="Dynamics.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> MATLAB Interface for Azure Services
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Overview.html">MATLAB Interface <em>for Azure Services</em></a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Azure Data Explorer</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="ADXGettingStarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="ADXAuthentication.html">Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="NullData.html">Null data</a></li>
<li class="toctree-l1"><a class="reference internal" href="Dynamics.html">Dynamic Data</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Performance</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#parallel-processing">Parallel Processing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#custom-row-decoder">Custom row decoder</a></li>
<li class="toctree-l2"><a class="reference internal" href="#donotparse-parallel-array-processing-experimental">doNotParse parallel array processing (Experimental)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#skip-parsing-row-array-elements-skiprowsarraydecode">Skip parsing row array elements (skipRowsArrayDecode)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="OpenAPI.html">Azure Data Explorer OpenAPI Spec</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Azure Key Vault</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="Authentication.html">Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="KeyVault.html">Azure Key Vault</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Azure Data Lake Storage Gen2</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="Configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="Authentication.html">Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="DataLakeStorageGen2.html">Azure Data Lake Storage Gen2</a></li>
<li class="toctree-l1"><a class="reference internal" href="File.html">File Data Lake Storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="Queue.html">Queue Storage</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Further topics</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Deployment.html">MATLAB Compiler (SDK) Deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="Testing.html">Unit Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="FAQ.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="APIReference.html">MATLAB Interface <em>for Azure Services</em> - API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="References.html">References</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">MATLAB Interface for Azure Services</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Performance</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/mathworks-ref-arch/matlab-azure-services/blob/main/Documentation/Performance.md" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="performance">
<h1>Performance<a class="headerlink" href="#performance" title="Permalink to this headline"></a></h1>
<p>This package uses the <a class="reference external" href="https://github.com/google/gson">GSON</a> Java library for
comprehensive JSON parsing, however this can have a performance impact when working
with queries that return large responses. If response times are slow and bandwidth
is not the issue the following should be considered:</p>
<ul class="simple">
<li><p>In general only KQL queries should return sufficient volumes of data to exhibit
query times that dominate the inherent communication time.</p></li>
<li><p>Return the minimum amount of data.</p></li>
<li><p>Where convenient to do so structure queries to perform data formatting and
filtering on the server side. This takes advantage of the proximity to the data
and the scale of the Azure Data Explorer platform.</p></li>
<li><p>Ingesting from files or tables uses binary transfers, typically with optimized
binary parquet files, for larger volumes of data this is far more efficient than
repeated inline ingestion of small amounts of data.</p></li>
<li><p>Simple JSON responses may be parsed faster using a custom row decoder, see below
for more details.</p></li>
<li><p>Return int32s rather than int64s if precision is not a limitation.</p></li>
<li><p>Avoid supporting nulls data if data is know to not have null values. See:
<a class="reference internal" href="NullData.html"><span class="doc std std-doc">NullData</span></a> for more details.</p></li>
<li><p>The MATLAB <a class="reference external" href="https://mathworks.com/help/matlab/matlab_prog/profiling-for-improving-performance.html">profiler</a>
can be a good way to visualize what portions of query processing are consuming most time.</p></li>
<li><p>If responses contain <a class="reference internal" href="Dynamics.html"><span class="doc std std-doc">dynamic</span></a> fields where not all values returned
may be used consider decoding them at the time of use as needed rather than as
part of the query.</p></li>
<li><p>If getting direct access to the raw data return in response is required, this
can be accomplished using the lower-level functions.</p></li>
</ul>
<section id="parallel-processing">
<h2>Parallel Processing<a class="headerlink" href="#parallel-processing" title="Permalink to this headline"></a></h2>
<p>If Parallel Computing Toolbox is installed (use <code class="docutils literal notranslate"><span class="pre">ver</span></code> to check), then it can be
used to speed up the processing of KQL query rows. Use the optional <code class="docutils literal notranslate"><span class="pre">useParallel</span></code>
argument to enable this (default is <code class="docutils literal notranslate"><span class="pre">false</span></code>). Additionally a threshold of rows
can be applied below which Parallel processing will not be used. The default is 1000.
The best value for this threshold will depend on the content of the rows and whether
repeated large row count calls are made, some experimentation may be required.
This can also be used with custom row decoders. The default row decoder requires
a process based parpool.</p>
<p>Here a parallel processing is enabled along with a custom row decoder, parallelism is applied for
queries returning 10000 rows or more.</p>
<p>Example:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">h</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">@</span><span class="n">mathworks</span><span class="p">.</span><span class="n">internal</span><span class="p">.</span><span class="n">adx</span><span class="p">.</span><span class="n">exampleCustomRowDecoder</span><span class="p">;</span><span class="w"></span>
<span class="p">[</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">success</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">mathworks</span><span class="p">.</span><span class="n">adx</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">query</span><span class="p">,</span><span class="w"> </span><span class="n">useParallel</span><span class="p">=</span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">parallelThreshold</span><span class="p">=</span><span class="mi">10000</span><span class="p">,</span><span class="w"> </span><span class="n">customRowDecoder</span><span class="p">=</span><span class="n">h</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</section>
<section id="custom-row-decoder">
<h2>Custom row decoder<a class="headerlink" href="#custom-row-decoder" title="Permalink to this headline"></a></h2>
<p>If queries result in a simple JSON response then writing a custom decoder to
extract the required data rather than using the default decoder.</p>
<p>A sample of such a decoder <code class="docutils literal notranslate"><span class="pre">/Software/MATLAB/app/system/+mathworks/+internal/+adx/exampleCustomRowDecoder.m</span></code>
is provided. This function handles an array of rows of the form: <code class="docutils literal notranslate"><span class="pre">[128030544,1.0,&quot;myStringValue-1&quot;]</span></code>
with fields of types int64, double and a string.</p>
<p>It will not process other data and is intended for speed rather than strict correctness or robustness.</p>
<p>The custom decoder is applied to the PrimaryResult rows field only.</p>
<p>It is required to return a cell array of size number of rows by the number of
columns that can be converted to a MATLAB table with the given schema.</p>
<p>It is not required to respect input arguments flags if foreknowledge of returned
data permits it.</p>
<p>Custom row decoders can be applied to progressive and nonprogressive KQL API v2
and KQL API v1 mode queries.</p>
<p>When a custom decoder is not used the generic decoder <code class="docutils literal notranslate"><span class="pre">mathworks.internal.adxgetRowsWithSchema</span></code>
is used.</p>
<p>A <a class="reference external" href="https://mathworks.com/help/matlab/matlab_prog/creating-a-function-handle.html">function handle</a>
is used to pass a handle to the custom row decoder to the <code class="docutils literal notranslate"><span class="pre">run</span></code> or <code class="docutils literal notranslate"><span class="pre">KQLquery</span></code> commands.</p>
<p>Example:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">sprintf</span><span class="p">(</span><span class="s">&#39;table(&quot;%s&quot;, &quot;all&quot;)&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">tableName</span><span class="p">);</span><span class="w"></span>
<span class="n">crd</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">@</span><span class="n">mathworks</span><span class="p">.</span><span class="n">internal</span><span class="p">.</span><span class="n">adx</span><span class="p">.</span><span class="n">exampleCustomRowDecoder</span><span class="p">;</span><span class="w"></span>
<span class="p">[</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">success</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">mathworks</span><span class="p">.</span><span class="n">adx</span><span class="p">.</span><span class="n">run</span><span class="p">(</span><span class="n">query</span><span class="p">,</span><span class="w"> </span><span class="n">customRowDecoder</span><span class="p">=</span><span class="n">crd</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">exampleCustomRowDecoder</span></code> example implements a Parallel Computing based <code class="docutils literal notranslate"><span class="pre">parfor</span></code>
based parallelization, this is not required but may be helpful.</p>
<blockquote>
<div><p>Depending on the nature of the decoder code a process based pool may be required
rather than a thread based pool.
It is unlikely that a decoding process would benefit from a remote processing via
a cluster based pool but this would be possible.</p>
</div></blockquote>
</section>
<section id="donotparse-parallel-array-processing-experimental">
<h2>doNotParse parallel array processing (Experimental)<a class="headerlink" href="#donotparse-parallel-array-processing-experimental" title="Permalink to this headline"></a></h2>
<p>A JSON array of <code class="docutils literal notranslate"><span class="pre">doNotParse</span></code> values being processed by <code class="docutils literal notranslate"><span class="pre">JSONMapper</span></code> must be checked
for paired double quotes added to some value types the gson <code class="docutils literal notranslate"><span class="pre">toString</span></code> method.
While trivial this can be slow if there are many elements for example, row values.</p>
<p>An experimental flag (<code class="docutils literal notranslate"><span class="pre">useParallel</span></code>) can be set to true to enable parallel
processing of this step using <code class="docutils literal notranslate"><span class="pre">parfor</span></code> if Parallel Computing Toolbox is available.
The property can be set in: <code class="docutils literal notranslate"><span class="pre">/Software/MATLAB/app/system/+adx/+control/JSONMapper.m</span></code>
in the <code class="docutils literal notranslate"><span class="pre">fromJSON</span></code> method.</p>
</section>
<section id="skip-parsing-row-array-elements-skiprowsarraydecode">
<h2>Skip parsing row array elements (skipRowsArrayDecode)<a class="headerlink" href="#skip-parsing-row-array-elements-skiprowsarraydecode" title="Permalink to this headline"></a></h2>
<blockquote>
<div><p>The following applies to v2 queries only.</p>
</div></blockquote>
<p>While the Rows array elements are not parsed by the the generation of a <code class="docutils literal notranslate"><span class="pre">adx.data.models.QueryV2ResponseRaw</span></code>
in a <code class="docutils literal notranslate"><span class="pre">adx.data.api.Query.queryRun</span></code> call prior to the generation of a MATLAB table,
as done by the higher-level <code class="docutils literal notranslate"><span class="pre">mathworks.adx.KQLQuery</span></code> function, the array
itself is parsed.</p>
<p>If the optional named argument <code class="docutils literal notranslate"><span class="pre">skipRowsArrayDecode</span></code> is used with a <code class="docutils literal notranslate"><span class="pre">adx.data.api.Query.queryRun</span></code>
call then the frames are parsed but the Rows array itself is not. This enables
If parsing the Rows independently if needed in a performance optimal way.</p>
<p>Example:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="c">% Create a request</span><span class="w"></span>
<span class="n">request</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">adx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">models</span><span class="p">.</span><span class="n">QueryRequest</span><span class="p">();</span><span class="w"></span>
<span class="n">request</span><span class="p">.</span><span class="n">csl</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;mytablename | take  100&quot;</span><span class="p">;</span><span class="w"></span>

<span class="c">% Create the Query object and run the request</span><span class="w"></span>
<span class="n">query</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">adx</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">api</span><span class="p">.</span><span class="n">Query</span><span class="p">();</span><span class="w"></span>
<span class="p">[</span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">response</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">query</span><span class="p">.</span><span class="n">queryRun</span><span class="p">(</span><span class="n">request</span><span class="p">,</span><span class="w"> </span><span class="n">apiVersion</span><span class="p">=</span><span class="s">&quot;v2&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">skipRowsArrayDecode</span><span class="p">=</span><span class="nb">true</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Dynamics.html" class="btn btn-neutral float-left" title="Dynamic Data" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="OpenAPI.html" class="btn btn-neutral float-right" title="Azure Data Explorer OpenAPI Spec" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020-2024, MathWorks, Inc..</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>